---
title: "**Contaminación y muerte prenatal**"
author: "Alvar Martínez e Iván Mamolar"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 5
---
<style>
body {
text-align: justify}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


* [Repositorio de GitHub](https://github.com/ivanmr200/seminario_fuentes) 


## **Introducción**


La **mortalidad prenatal** se refiere a aquellos bebés que fallecen pasadas las 28 semanas de embarazo (a partir del séptimo mes) y que no llegan a término.
Las pricipales causas son las complicaciones que surgen durante el embarazo ya sean por infecciones como sífilis o VIH, otros tipos de anomalías maternas, como diabetes o hipertensión o hábitos perjudiciales como el consumo de tabaco o el alcohol.

Además de estos factores, las condiciones ambientales pueden tener un efecto negativo en el embarazo. Estudios sugieren que la presencia de contaminantes en el aire pueden causar complicaciones en el embarazo e incluso aumentar la probabilidad de partos prematuros, así como la exposición al ruido puede tener efectos adversos para el embarazo pudiendo llegar a afectar a la mortalidad prenatal. 

En este seminario, vamos a tratar de demostrar si estos estudios se cumplen en las distintas comunidades autónomas españolas, analizando la relación que hay entre la **calidad del aire** y la **contaminación acústica** con la mortalidad prenatal.

![](./Input/IMAGES/muerteprenatal.jpg)

## **Objetivos**

El objetivo principal es demostrar si la contaminación del aire y la exposición al ruido pueden estar asociados con el número de casos de mortalidad fetal, a través de:

  - Analizar la concentración de PM 2.5 y PM 10 en el aire por comunidad autónoma.
  - Estudiar la relación entre la calidad del aire y mortalidad prenatal.
  - Analizar el porcentaje de población afectada por exceso de ruido en cada comunidad autónoma.
  - Estudiar la relación entre el exceso de ruido y mortalidad prenatal.



## **Metodología**

Los datos que vamos a utilizar han sido encontrados en la página oficial del Instituto Nacional de Estadística (INE) en el que se pueden encontrar una gran cantidad de datos de diferentes formatos como XLS, csv, JSON ... En nuestro caso los datos sobre mortalidad prenatal y contaminación son de fromato csv y JSON y se encuentran en la carpeta `DATA` dentro de la carpeta `Input` del repositorio.

Para poder utilizar estos conjuntos de datos son necesarios importarlos, para ello utilizaremos las siguientes librerías:

```{r , eval = TRUE,message=FALSE, warning=FALSE}
# Datos con formato .csv:
library(readr)

#Datos con formato .json:
library(tidyverse)
library(rjson)
library(tidyjson)

#Visualizacion resultados:
library(DT)
library(ggplot2)
library(gifski)
library(ggplot2)
library(gganimate)

```

### **Importación archivos**

Una vez cargadas las librerías se pueden importar los datos. 

#### Importación datos CSV:

En algunos de nuestros archivos csv, es necesario especificar el tipo de codificación que tienen, para que R pueda leer correctamente los caracteres especiales como *tildes* o *ñ*. En nuestro caso utilizan la codificacion *ISO 8859-1* que corresponde con el alfabeto español :

```{r , eval = TRUE,message=FALSE}

# Para conocer el tipo de codificación: 
encoding <- guess_encoding("Input/DATA/media_anual_PM2_5.csv")
print(encoding)

```

```{r , eval = TRUE,message=FALSE}

PM2_media <- read_delim("Input/DATA/media_anual_PM2_5.csv", 
                        delim = ";", escape_double = FALSE, trim_ws = TRUE, 
                        locale = locale(encoding = "ISO-8859-1"))

PM10_media <- read_delim("Input/DATA/media_anual_PM10.csv", 
                        delim = ";", escape_double = FALSE, trim_ws = TRUE, 
                        locale = locale(encoding = "ISO-8859-1"))

RUIDO_media <- read_delim("Input/DATA/poblacion_sufre_ruidos.csv", 
                         delim = ";", escape_double = FALSE, trim_ws = TRUE)

```

#### Preparación datos csv

Los datos en los archivos csv estan distribuidos de tal forma que puede dificultar su comprensión y manejo, por ello vamos a modificarlos y ordenarlos.

El objetivo es conseguir que los años (*periodo*), que de forma predeterminada vienen en una única columna pasen a ser las columnas del dataframe y el nombre de las comunidades autónomas las filas. Además, eliminar aquellas columnas y filas que no son de nuestro interés.

```{r , eval = TRUE,message=FALSE}
# Datos concentración anual PM 2.5
PM2_ccaa_media <- PM2_media %>%
  pivot_wider(names_from = periodo, values_from = Total)%>% 
  select(-`Total Nacional`)%>% #Eliminar columna Total Nacional
  slice(-1)%>%                    #Eliminar fila Total Nacional
  pivot_longer(
    cols = c("2022":"2004"),names_to = "Año",values_to = "PM2_5"
  )                    

datatable(PM2_ccaa_media)
```


```{r , eval = TRUE,message=FALSE}
# Datos concentración anual PM 10
PM10_CCAA_media <- PM10_media %>%
  pivot_wider(names_from = periodo, values_from = Total)%>%
  select(-`Total Nacional`)%>%
  slice(-1)%>%
  pivot_longer(names_to = "Año", values_to = "PM10", cols = c("2022":"2004"))

datatable(PM10_CCAA_media)
```


```{r , eval = TRUE,message=FALSE}
#Datos población afectada por ruidos
RUIDO_CCAA_media <- RUIDO_media %>%
  pivot_wider(names_from = periodo, values_from = Total)%>%
  select(-`Total Nacional`)%>%
  slice(-1) %>%
  pivot_longer(names_to = "Año", values_to = "Ruido", cols = c("2020":"2004"))

```

El nombre de las Comunidades Autónomas en los archivos csv aparecen con un índice que en nuestro caso vamos a eliminar ya que no lo utilizaremos y nos dificulta el tratamiento de las tablas.

*(En las tablas referentes a contaminación, se cambiará más adelante)*

En el caso del ruido: 

```{r , eval = TRUE,message=FALSE}
RUIDO_CCAA <- 
  RUIDO_CCAA_media %>%
  mutate(Comunidades_Autonomas = case_when(
    RUIDO_CCAA_media$`Comunidades y Ciudades Autónomas`== "01 Andalucía" ~ "Andalucía",
    RUIDO_CCAA_media$`Comunidades y Ciudades Autónomas`== "02 Aragón" ~ "Aragón",
    RUIDO_CCAA_media$`Comunidades y Ciudades Autónomas`== "03 Asturias, Principado de" ~ "Asturias, Principado de",
    RUIDO_CCAA_media$`Comunidades y Ciudades Autónomas`== "04 Balears, Illes" ~ "Balears, Illes",
    RUIDO_CCAA_media$`Comunidades y Ciudades Autónomas`== "05 Canarias" ~ "Canarias",
    RUIDO_CCAA_media$`Comunidades y Ciudades Autónomas`== "06 Cantabria" ~ "Cantabria",
    RUIDO_CCAA_media$`Comunidades y Ciudades Autónomas`== "07 Castilla y León" ~ "Castilla y León",
    RUIDO_CCAA_media$`Comunidades y Ciudades Autónomas`== "08 Castilla - La Mancha" ~ "Castilla - La Mancha",
    RUIDO_CCAA_media$`Comunidades y Ciudades Autónomas`== "09 Cataluña" ~ "Cataluña",
    RUIDO_CCAA_media$`Comunidades y Ciudades Autónomas`== "10 Comunitat Valenciana" ~ "Comunitat Valenciana",
    RUIDO_CCAA_media$`Comunidades y Ciudades Autónomas`== "11 Extremadura" ~ "Extremadura",
    RUIDO_CCAA_media$`Comunidades y Ciudades Autónomas`== "12 Galicia" ~ "Galicia",
    RUIDO_CCAA_media$`Comunidades y Ciudades Autónomas`== "13 Madrid, Comunidad de" ~ "Madrid, Comunidad de",
    RUIDO_CCAA_media$`Comunidades y Ciudades Autónomas`== "14 Murcia, Región de" ~ "Murcia, Región de",
    RUIDO_CCAA_media$`Comunidades y Ciudades Autónomas`== "15 Navarra, Comunidad Foral de" ~ "Navarra, Comunidad Foral de",
    RUIDO_CCAA_media$`Comunidades y Ciudades Autónomas`== "16 País Vasco" ~ "País Vasco",
    RUIDO_CCAA_media$`Comunidades y Ciudades Autónomas`== "17 Rioja, La" ~ "Rioja, La",
    RUIDO_CCAA_media$`Comunidades y Ciudades Autónomas`== "18 Ceuta" ~ "Ceuta",
    RUIDO_CCAA_media$`Comunidades y Ciudades Autónomas`== "19 Melilla" ~ "Melilla",
    ))%>%
  select(Comunidades_Autonomas, everything())%>%
  select(-`Comunidades y Ciudades Autónomas`)

datatable(RUIDO_CCAA)

```

#### **Importación datos JSON:**

```{r , eval = TRUE,message=FALSE, warning=FALSE}

mort_prenatal <- fromJSON(file = "INPUT/DATA/mortalidad_prenatal_total.json")

mort_prenatal %>% 
  spread_all()

```

#### Preparación archivos .json

Una vez que hemos importado el archivo json, analizamos los tipos de los atributos que lo forman para quedarnos con aquellos de tipo *array* que son  los que contienen la información que queremos:

```{r , eval = TRUE,message=FALSE}

mort_prenatal %>% 
  gather_object %>% 
  json_types %>% 
  count(name, type)

```
En nuestro caso queremos estudiar la mortalidad prenatal tanto en hombres como en mujeres, para ello filtramos eliminando las columnas de hombres y mujeres quedándonos con las de ambos sexos:


```{r , eval = TRUE,message=FALSE}

filter <- c()
for (i in 1:60){
  filter <- append(filter, mort_prenatal[[i]]$MetaData[[4]]$Nombre == "Ambos sexos")
}
elim = 0
for (i in 1:60){
  if(!filter[i]){
    mort_prenatal[[i-elim]] <- NULL
    elim <- elim + 1
  }
}

```

Analizamos en profundidad el contenido de cada array y obtenemos lo siguiente:

- *Array Data*: se encuentran los valores de todos los años y sus respectivos valores de tasa de mortalidad prenatal

```{r , eval = TRUE,message=FALSE}

#VALORES DE LOS AÑOS A PARTIR DE 2004 Y VALORES MORTALIDAD
mort_valores_prenatal <-
  mort_prenatal %>%
  enter_object(Data) %>%
  gather_array %>%
  spread_all %>%
  select(Anyo, Valor, document.id)%>% 
  filter(Anyo >=2004)

```

- *Array Metadata*: están los nombres de las comunidades autónomas y clasficación por sexos

```{r , eval = TRUE,message=FALSE}

mort2_CCAA_prenatal <- mort_prenatal %>%
  enter_object(MetaData) %>%
  gather_array %>%
  spread_all %>%
  select(Nombre, document.id, T3_Variable) %>%
  filter(Nombre == "Andalucía" | Nombre == "Aragón" | Nombre == "Asturias, Principado de" |
           Nombre == "Balears, Illes" | Nombre == "Canarias" | Nombre == "Cantabria" |
           Nombre == "Castilla y León" | Nombre == "Castilla - La Mancha" | Nombre == "Cataluña" |
           Nombre == "Comunitat Valenciana" | Nombre == "Extremadura" | Nombre == "Galicia" |
           Nombre == "Madrid, Comunidad de" | Nombre == "Murcia, Región de" | Nombre == "Navarra, Comunidad Foral de" |
           Nombre == "País Vasco" | Nombre == "Rioja, La" | Nombre == "Ceuta" | Nombre == "Melilla") 

```

Para obtener la tabla con todos los datos bien estructurados y organizados es necesario hacer join entre los datos de ambos arrays:

```{r , eval = TRUE,message=FALSE}
#Join:
JOIN_mort_prenatal <-
  mort_valores_prenatal %>% 
  select(c("Anyo", "Valor", "document.id")) %>%
  full_join(x = ., 
            y = mort2_CCAA_prenatal %>% 
              select(c("Nombre", "document.id")),
            by = c("document.id") )
```

```{r , eval = TRUE,message=FALSE}

mortalidad <- JOIN_mort_prenatal %>%
  select(Nombre, Anyo, Valor)%>%
  pivot_wider(names_from = Anyo, values_from = Valor)%>% #Hacer que filas = CCAA y columnas = años
  slice(-1)%>%#Eliminar datos Total Nacional
  pivot_longer(names_to = "Año", values_to = "Mortalidad", cols = c("2022":"2004"))%>%
  rename(Comunidades_Autonomas = "Nombre")
  
datatable(mortalidad)

```

## **Concentración contaminantes en el aire por CCAA**

A continuación relacionaremos las dos tablas de contaminación, obteniendo un valor medio entre estas PM2.5 y PM10, para posteriormente hacer una unión con la mortalidad.

```{r , eval = TRUE,message=FALSE, warning=FALSE}


# Limpiar los datos, eliminando valores no numéricos o incorrectos
# Reemplazar comas por puntos decimales y convertir a numérico

PM2_ccaa_media <- PM2_ccaa_media %>%
  mutate(PM2_5 = as.numeric(gsub(",", ".", as.character(PM2_5))))

PM10_CCAA_media <- PM10_CCAA_media %>%
  mutate(PM10 = as.numeric(gsub(",", ".", as.character(PM10))))



# Unir las tablas por "Comunidades y Ciudades Autónomas" y "año"
calidad_aire <- PM2_ccaa_media %>%
  inner_join(PM10_CCAA_media, by = c("Comunidades y Ciudades Autónomas", "Año"))

# Calcular la media para cada comunidad y año, ignorando los valores NA
tabla_aire <- calidad_aire %>%
  mutate(media_PM = rowMeans(select(., PM2_5, PM10), na.rm = TRUE)) %>% # Calcular media entre PM2.5 y PM10
  group_by(`Comunidades y Ciudades Autónomas`, Año) %>%
  summarize(media_PM = mean(media_PM, na.rm = TRUE), .groups = "drop") # Media por grupo ignorando NA
```

Cambio de nombre de atributo *Comunidades y Ciudades Autónomas*
```{r , eval = TRUE,message=FALSE, warning=FALSE}
media_calidad_aire <- 
  tabla_aire %>%
  mutate(Comunidades_Autonomas = case_when(
    tabla_aire$`Comunidades y Ciudades Autónomas`== "01 Andalucía" ~ "Andalucía",
    tabla_aire$`Comunidades y Ciudades Autónomas`== "02 Aragón" ~ "Aragón",
    tabla_aire$`Comunidades y Ciudades Autónomas`== "03 Asturias, Principado de" ~ "Asturias, Principado de",
    tabla_aire$`Comunidades y Ciudades Autónomas`== "04 Balears, Illes" ~ "Balears, Illes",
    tabla_aire$`Comunidades y Ciudades Autónomas`== "05 Canarias" ~ "Canarias",
    tabla_aire$`Comunidades y Ciudades Autónomas`== "06 Cantabria" ~ "Cantabria",
    tabla_aire$`Comunidades y Ciudades Autónomas`== "07 Castilla y León" ~ "Castilla y León",
    tabla_aire$`Comunidades y Ciudades Autónomas`== "08 Castilla - La Mancha" ~ "Castilla - La Mancha",
    tabla_aire$`Comunidades y Ciudades Autónomas`== "09 Cataluña" ~ "Cataluña",
    tabla_aire$`Comunidades y Ciudades Autónomas`== "10 Comunitat Valenciana" ~ "Comunitat Valenciana",
    tabla_aire$`Comunidades y Ciudades Autónomas`== "11 Extremadura" ~ "Extremadura",
    tabla_aire$`Comunidades y Ciudades Autónomas`== "12 Galicia" ~ "Galicia",
    tabla_aire$`Comunidades y Ciudades Autónomas`== "13 Madrid, Comunidad de" ~ "Madrid, Comunidad de",
    tabla_aire$`Comunidades y Ciudades Autónomas`== "14 Murcia, Región de" ~ "Murcia, Región de",
    tabla_aire$`Comunidades y Ciudades Autónomas`== "15 Navarra, Comunidad Foral de" ~ "Navarra, Comunidad Foral de",
    tabla_aire$`Comunidades y Ciudades Autónomas`== "16 País Vasco" ~ "País Vasco",
    tabla_aire$`Comunidades y Ciudades Autónomas`== "17 Rioja, La" ~ "Rioja, La",
    tabla_aire$`Comunidades y Ciudades Autónomas`== "18 Ceuta" ~ "Ceuta",
    tabla_aire$`Comunidades y Ciudades Autónomas`== "19 Melilla" ~ "Melilla",
    ))%>%
  select(Comunidades_Autonomas, everything())%>%
  select(-`Comunidades y Ciudades Autónomas`)
  

# Ver los resultados de la media
datatable(media_calidad_aire)


```
Podemos visualizar la evolución de la concentración de particulas en el aire:
```{r , echo = FALSE, eval = TRUE,message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
library(mapSpain)
library(gganimate)
library(gifski)
library(ggplot2)
library(gganimate)

# Paso 1: Preparar los datos y unificar nombres
# Asegúrate de que tienes un dataframe con las columnas de año
datos <- media_calidad_aire %>%
  mutate(
    Comunidades_Autonomas = gsub("^\\d+ ", "", Comunidades_Autonomas) %>% trimws(),
    valor = as.numeric(gsub(",", ".", media_PM)),
    Año = as.integer(Año)
  )

# Paso 2: Obtener el codelist, unificar con datos y shapefile
ccaa_sf <- esp_get_ccaa() %>%
  left_join(
    mapSpain::esp_codelist %>% select(ine.ccaa.name, codauto) %>%
      rename(Comunidades_Autonomas = ine.ccaa.name) %>%
      distinct(),
    by = "codauto"
  ) %>%
  left_join(datos, by = "Comunidades_Autonomas") %>%
  mutate(valor = replace_na(valor, 0))

# Paso 3: Graficar el mapa con animación

# Crea el gráfico animado

grafico_animado <- ggplot(ccaa_sf) +
  geom_sf(aes(fill = valor), color = "grey70", linewidth = .3) +
  geom_sf(data = esp_get_can_box(), color = "grey70") +
  scale_fill_gradientn(
    colors = hcl.colors(10, "Blues", rev = TRUE),
    n.breaks = 10,
    guide = guide_legend(title = "Valor medio PM", position = "inside")
  ) +
  theme_void() +
  theme(legend.position = c(0.1, 0.6)) +
  labs(title = "Valor medio PM 2.5 y PM10 en el aire | Año: {frame_time}", fill = "Valor medio PM") +
  transition_time(Año) +
  ease_aes("linear")

grafico_animado_contaminacion <- animate(grafico_animado, nframes = 85, fps = 4)

# Renderiza la animación
grafico_animado_contaminacion
```








## **Relación contaminación - mortalidad prenatal**

Ahora relacionaremos la tabla anterior con la mortalidad prental.
```{r , eval = TRUE,message=FALSE}


mortalidad_aire <-
  full_join(x = media_calidad_aire, y = mortalidad, by = c("Comunidades_Autonomas", "Año"))
  
            
datatable(mortalidad_aire)

```

Una vez obtenida la tabla con los datos de concentración media de PM y de mortalidad prenatal por año y comunidad autónomas podemos ver si existe alguna relación.

```{r, echo = FALSE, message=FALSE, warning=FALSE}

# Asegurar que Año sea numérico
mortalidad_aire$Año <- as.integer(mortalidad_aire$Año)

p <- ggplot(mortalidad_aire, aes(x = media_PM, y = Mortalidad, colour = Comunidades_Autonomas)) +
  geom_point(aes(colour = factor(Comunidades_Autonomas)),alpha = 0.7, size = 4, show.legend = TRUE) +  
  scale_color_viridis_d() +
  facet_wrap(~ Comunidades_Autonomas) +
  labs(
    title = 'Año: {frame_time}',
    x = 'Concentración media de PM (µg/m³)',
    y = 'Mortalidad prenatal (por mil)',
    color = "Comunidad Autónoma"
  ) +
  theme_minimal() +
  transition_time(Año) +
  ease_aes('linear')

grafico_animado <- animate(p, nframes = 85, fps = 10)
grafico_animado
```
#### Conclusiones:

## **Población afectada por ruido**

```{r , echo = FALSE, eval = TRUE,message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
library(mapSpain)
library(gganimate)
library(gifski)
library(ggplot2)
library(gganimate)

# Paso 1: Preparar los datos y unificar nombres
# Asegúrate de que tienes un dataframe con las columnas de año
datos <- RUIDO_CCAA %>%
  mutate(
    Comunidades_Autonomas = gsub("^\\d+ ", "", Comunidades_Autonomas) %>% trimws(),
    valor = as.numeric(gsub(",", ".", Ruido)),
    Año = as.integer(Año)
  )

# Paso 2: Obtener el codelist, unificar con datos y shapefile
ccaa_sf <- esp_get_ccaa() %>%
  left_join(
    mapSpain::esp_codelist %>% select(ine.ccaa.name, codauto) %>%
      rename(Comunidades_Autonomas = ine.ccaa.name) %>%
      distinct(),
    by = "codauto"
  ) %>%
  left_join(datos, by = "Comunidades_Autonomas") %>%
  mutate(valor = replace_na(valor, 0))

# Paso 3: Graficar el mapa con animación

# Crea el gráfico animado

grafico_animado <- ggplot(ccaa_sf) +
  geom_sf(aes(fill = valor), color = "grey70", linewidth = .3) +
  geom_sf(data = esp_get_can_box(), color = "grey70") +
  scale_fill_gradientn(
    colors = hcl.colors(10, "Blues", rev = TRUE),
    n.breaks = 10,
    guide = guide_legend(title = "Valor medio PM", position = "inside")
  ) +
  theme_void() +
  theme(legend.position = c(0.1, 0.6)) +
  labs(title = "Población afectada por ruido | Año: {frame_time}", fill = "% población afectada por ruido") +
  transition_time(Año) +
  ease_aes("linear")

grafico_animado_ruido <- animate(grafico_animado, nframes = 85, fps = 3)

# Renderiza la animación
grafico_animado_ruido
```

```{r , eval = TRUE,message=FALSE}
# Suponiendo que tienes un dataframe 'datos' con las columnas 'Comunidad_Autonoma', 'Año' y 'Ruido'
ggplot(RUIDO_CCAA, aes(x = factor(Año), y = Ruido, fill = Comunidades_Autonomas)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Evolución del Ruido por Comunidad Autónoma",
    x = "Año",
    y = "Valor de Ruido"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")

```



```{r , eval = TRUE,message=FALSE}
ggplot(RUIDO_CCAA, aes(x = Año, y = Ruido, color = Comunidades_Autonomas)) +
  geom_point() +
  labs(title = "Ruido por Comunidad Autónoma y Año", 
       x = "Año", 
       y = "Valor de Ruido") +
  theme_minimal() +
  theme(legend.position = "bottom")

```




## **Relación entre contaminación acústica - mortalidad prenatal**


A continuación haremos lo mismo pero en este caso, uniendo la tabla de mortalidad prenatal junto con la de ruido ambiente.
```{r , eval = TRUE,message=FALSE}


mortalidad_RUIDO <- 
  full_join(x = RUIDO_CCAA, y = mortalidad, by = c("Comunidades_Autonomas", "Año"))
            
datatable(mortalidad_RUIDO)


```



## Representar resultados

Representaremos unas gráficas en las que se vea la evolución de la muerte prenatal en función de las dos variables planteadas; Ruido y Media_PM.

```{r , eval = TRUE,message=FALSE}

# Verificar si hay datos para la comunidad seleccionada
cat("Comunidades autónomas disponibles:\n")
print(unique(mortalidad_aire$"Comunidades Autonomas"))  # Lista las comunidades únicas

# Pedir al usuario que introduzca una comunidad autónoma
comunidad_seleccionada <- readline(prompt = "Introduce la comunidad autónoma que deseas analizar: ")

# Filtrar los datos para la comunidad seleccionada
datos_filtrados <- mortalidad_aire %>% 
  filter("Comunidades Autonomas" == comunidad_seleccionada)

# Filtrar los datos para la comunidad seleccionada
datos_filtrados <- subset(mortalidad_aire, "Comunidades Autonomas" == comunidad_seleccionada)

# Verificar si hay datos para la comunidad seleccionada
if (nrow(datos_filtrados) == 0) {
  cat("No hay datos disponibles para la comunidad autónoma seleccionada:", comunidad_seleccionada, "\n")
} else {
  # Crear la gráfica
  grafica <- ggplot(datos_filtrados, aes(x = año)) +
    geom_line(aes(y = media_PM, color = "Media PM2.5"), size = 1) +
    geom_line(aes(y = Mortalidad, color = "Mortalidad"), size = 1) +
    geom_point(aes(y = Mortalidad, color = "Mortalidad"), size = 2) +
    labs(
      title = paste("Evolución de Mortalidad y Contaminación en", comunidad_seleccionada),
      x = "Año",
      y = "Valores",
      color = "Indicador"
    ) +
    theme_minimal()

  # Mostrar la gráfica
  print(grafica)
}


```

Idea primer objetivo: realizar un mapa en el que se vean los distintos datos usando los siguientes paquetes:

```{r , eval = TRUE,message=FALSE}

#library(mapSpain)
#library(sf)
#library(dplyr)
#library(ggplot2)

```


